pipeline {
    agent any

    environment {
        DEV_SERVER = 'Dev-Server' // SSH server configuration in Jenkins
        REMOTE_DIR = '/home/ubuntu/karan' // Remote directory on the server
        BITBUCKET_CREDENTIALS = credentials('bitbucket-credentials') // Bitbucket credentials
        SONAR_SCANNER_HOME = '/opt/sonar-scanner' // Path to SonarScanner
        SONAR_LOGIN = credentials('sonar-login') // SonarQube login token
        SONAR_PASSWORD = credentials('sonar-password') // SonarQube password
    }

    stages {
        stage('Pull Code') {
            steps {
                script {
                    echo 'Pulling latest code from Git repository on the development server...'
                    sshExecute(
                        server: env.DEV_SERVER,
                        command: """
                            cd ${env.REMOTE_DIR} &&
                            git pull https://${BITBUCKET_CREDENTIALS_USR}:${BITBUCKET_CREDENTIALS_PSW}@bitbucket.org/karanravat60/f.git main
                        """
                    )
                }
            }
        }

        stage('Build Project') {
            steps {
                script {
                    echo 'Building the project...'
                    sshExecute(
                        server: env.DEV_SERVER,
                        command: """
                            cd ${env.REMOTE_DIR} &&
                            npm install --force &&
                            npm run build
                        """
                    )
                }
            }
        }

        stage('Run SonarQube Analysis') {
            steps {
                script {
                    echo 'Running SonarQube analysis on the development server...'
                    sshExecute(
                        server: env.DEV_SERVER,
                        command: """
                            cd ${env.REMOTE_DIR} &&
                            ${env.SONAR_SCANNER_HOME}/bin/sonar-scanner \
                            -Dsonar.login=${env.SONAR_LOGIN} \
                            -Dsonar.password=${env.SONAR_PASSWORD}
                        """
                    )
                }
            }
        }

        stage('Deploy Project') {
            steps {
                script {
                    echo 'Deploying the project...'
                    sshExecute(
                        server: env.DEV_SERVER,
                        command: """
                            cd ${env.REMOTE_DIR} &&
                            pm2 delete test-admin || true &&
                            pm2 start npm --name test-admin -- run start
                        """
                    )
                }
            }
        }
    }

    post {
        success {
            script {
                // Replace this with the method for notifying success
                hangoutsNotifySuccess(token: credentials('hangouts-chat-token'))
            }
        }
        failure {
            script {
                hangoutsNotifyFailure(token: credentials('hangouts-chat-token'))
            }
        }
    }
}

// Define a reusable function for SSH execution to avoid redundancy
def sshExecute(Map params) {
    sshPublisher(
        publishers: [
            sshPublisherDesc(
                configName: params.server,
                transfers: [
                    sshTransfer(
                        sourceFiles: '',
                        execCommand: params.command,
                        execTimeout: params.timeout ?: 60000, // Default timeout if not specified
                        usePty: true
                    )
                ],
                usePromotionTimestamp: false,
                verbose: true
            )
        ]
    )
}
